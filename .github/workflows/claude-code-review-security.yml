name: Claude Code Security Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-security-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Security Review
        id: claude-security-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request.

            Focus ONLY on the difference against the `main` branch. Leave no comments on things we haven't changed in THIS PR.
            
            Four our review, focus specifically on:
            - Security vulnerabilities (injection attacks, XSS, CSRF, authentication/authorization issues)
            - Sensitive data exposure (secrets, credentials, PII)
            - Performance issues (N+1 queries, memory leaks, inefficient algorithms)
            - Resource exhaustion risks (unbounded loops, missing timeouts)

            Everything of those concerns go in their own <details> section.

            Be thorough but concise. Only report actual concerns, not hypotheticals.

            Use `gh pr review --comment` with your Bash tool to leave your review as a comment on the PR.

          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
